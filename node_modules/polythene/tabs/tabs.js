"use strict";Object.defineProperty(exports,"__esModule",{value:true});require("polythene/common/object.assign");var _polythene=require("polythene/polythene/polythene");var _polythene2=_interopRequireDefault(_polythene);var _mithril=require("mithril");var _mithril2=_interopRequireDefault(_mithril);var _button=require("polythene/button/button");var _button2=_interopRequireDefault(_button);var _icon=require("polythene/icon/icon");var _icon2=_interopRequireDefault(_icon);var _iconButton=require("polythene/icon-button/icon-button");var _iconButton2=_interopRequireDefault(_iconButton);var _scrollTo=require("polythene/common/scroll-to");var _scrollTo2=_interopRequireDefault(_scrollTo);var _theme=require("polythene/tabs/theme/theme");var _theme2=_interopRequireDefault(_theme);var _config=require("polythene/tabs/theme/config");var _config2=_interopRequireDefault(_config);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var CSS_CLASSES={block:"pe-tabs",scrollButton:"pe-tabs__scroll-button",scrollButtonLeft:"pe-tabs__scroll-button--start",scrollButtonRight:"pe-tabs__scroll-button--end",scrollButtonOffset:"pe-tabs__scroll-button--offset",tabRow:"pe-tabs__row",tabRowCentered:"pe-tabs__row--centered",tabRowIndent:"pe-tabs__row--indent",tab:"pe-tabs__tab",tabContent:"pe-tabs__tab-content",tabHasIcon:"pe-tabs__tab---icon",indicator:"pe-tabs__indicator",scrollable:"pe-tabs--scrollable",isAutofit:"pe-tabs--autofit",isAtStart:"pe-tabs--start",isAtEnd:"pe-tabs--end",isMenu:"pe-tabs--menu",isSmall:"pe-tabs--small",activeSelected:"pe-tabs__active-selected",label:"pe-button__label"};var POSITION_LEFT=1<<1;var POSITION_RIGHT=1<<2;var getNewIndex=function getNewIndex(index,tabs){var minTabIndex=0;var maxTabIndex=tabs.length-1;return{left:Math.max(index-1,minTabIndex),right:Math.min(index+1,maxTabIndex)}};var handleScrollButtonClick=function handleScrollButtonClick(ctrl,opts,e,direction){e.stopPropagation();e.preventDefault();var tabs=ctrl.tabs;var currentTabIndex=ctrl.selectedTabIndex;var newIndex=getNewIndex(currentTabIndex,tabs)[direction];scrollToTab(ctrl,newIndex,tabs,ctrl.scrollerEl);if(newIndex!==currentTabIndex){setSelectedTab(ctrl,opts,newIndex,true);_mithril2.default.redraw()}};var createScrollButton=function createScrollButton(ctrl,position,opts){var scrollIconForward=opts.scrollIconForward||_theme2.default.arrowForward;var scrollIconBackward=opts.scrollIconBackward||_theme2.default.arrowBackward;return _mithril2.default.component(_iconButton2.default,{"class":[CSS_CLASSES.scrollButton,position===POSITION_LEFT?CSS_CLASSES.scrollButtonLeft:CSS_CLASSES.scrollButtonRight].join(" "),icon:position===POSITION_LEFT?scrollIconBackward:scrollIconForward,ripple:{center:true},config:function config(el){if(ctrl.scrollButtonLeftEl&&ctrl.scrollButtonRightEl){return}if(position===POSITION_LEFT){ctrl.scrollButtonLeftEl=el}else{ctrl.scrollButtonRightEl=el}},events:{onclick:position===POSITION_LEFT?function(e){handleScrollButtonClick(ctrl,opts,e,"left")}:function(e){handleScrollButtonClick(ctrl,opts,e,"right")}}})};var alignToTitle=function alignToTitle(ctrl){var firstTab=ctrl.tabs[0].el;var firstInnerLabel=firstTab.querySelector("."+CSS_CLASSES.label+" span");var firstOuterLabelWidth=firstTab.getBoundingClientRect().width;var firstInnerLabelWidth=firstInnerLabel.getBoundingClientRect().width;var firstTabOffset=(firstOuterLabelWidth-firstInnerLabelWidth)/2;firstTab.style.marginLeft=-firstTabOffset+"px"};var createRightButtonOffset=function createRightButtonOffset(ctrl){var scrollButtonRightWidth=ctrl.scrollButtonRightEl.getBoundingClientRect().width;var scrollButtonOffsetEl=ctrl.tabsEl.querySelector("."+CSS_CLASSES.scrollButtonOffset);scrollButtonOffsetEl.style.width=scrollButtonRightWidth+"px"};var scrollToTab=function scrollToTab(ctrl,tabIndex,tabs,scroller){var left=tabs.slice(0,tabIndex).reduce(function(width,tabData){return width+tabData.el.getBoundingClientRect().width},0);var scrollerLeft=scroller["scrollLeft"];var duration=Math.abs(scrollerLeft-left)/_config2.default.tabs_scroll_speed;var delaySeconds=_config2.default.tabs_scroll_delay||0;setTimeout(function(){(0,_scrollTo2.default)({element:scroller,to:left,duration:Math.max(_config2.default.tabs_scroll_min_duration,duration),direction:"horizontal"})},delaySeconds*1e3)};var updateScrollButtons=function updateScrollButtons(ctrl){var scrollerEl=ctrl.scrollerEl;var scrollLeft=scrollerEl.scrollLeft;var currentTabIndex=ctrl.selectedTabIndex;var tabs=ctrl.tabs;var tabsEl=ctrl.tabsEl;var minTabIndex=0;var maxTabIndex=tabs.length-1;var isAtLeft=scrollerEl.scrollLeft===0&&currentTabIndex===minTabIndex;var isAtRight=scrollLeft>=scrollerEl.scrollWidth-tabsEl.getBoundingClientRect().width-1&&currentTabIndex===maxTabIndex;ctrl.scrollButtonStates.left=!isAtLeft;ctrl.scrollButtonStates.right=!isAtRight};var animateIndicator=function animateIndicator(selectedTabEl,animate,ctrl){var parentRect=ctrl.tabsEl.getBoundingClientRect();var rect=selectedTabEl.getBoundingClientRect();var style=ctrl.tabIndicatorEl.style;var translateX=rect.left-parentRect.left+ctrl.scrollerEl.scrollLeft;var transformCmd="translate("+translateX+"px, 0)";var duration=animate?_config2.default.indicator_slide_min_duration:0;style.width=rect.width+"px";style["transition-duration"]=style["-webkit-transition-duration"]=style["-moz-transition-duration"]=style["-o-transition-duration"]=duration+"s";style.transform=style["-webkit-transform"]=style["-moz-transform"]=style["-ms-transform"]=style["-o-transform"]=transformCmd};var setSelectedTab=function setSelectedTab(ctrl,opts,index,animate){ctrl.selectedTabIndex=index;if(!ctrl.tabs.length)return;var selectedTabEl=ctrl.tabs[index].el;if(selectedTabEl&&ctrl.tabIndicatorEl&&ctrl.tabsEl){animateIndicator(selectedTabEl,animate,ctrl)}if(ctrl.managesScroll){updateScrollButtons(ctrl)}if(opts.getState){opts.getState({index:index,data:ctrl.tabs[index].data,el:selectedTabEl})}};var createTab=function createTab(ctrl,opts,index,buttonOpts){var clickFn=function clickFn(){return setSelectedTab(ctrl,opts,index,opts.noIndicatorSlide?false:true)};buttonOpts.events=buttonOpts.events||{};buttonOpts.events.onclick=buttonOpts.events.onclick||function(){};var tabButtonOptions=Object.assign({},buttonOpts,{content:(0,_mithril2.default)("div",{"class":CSS_CLASSES.tabContent},[buttonOpts.icon?_mithril2.default.component(_icon2.default,buttonOpts.icon):null,buttonOpts.label?(0,_mithril2.default)("div",{"class":CSS_CLASSES.label},(0,_mithril2.default)("span",buttonOpts.label)):null]),"class":[CSS_CLASSES.tab,buttonOpts.icon&&buttonOpts.label?CSS_CLASSES.tabHasIcon:null,buttonOpts.class].join(" "),wash:false,ripple:true,events:Object.assign({},buttonOpts.events,{onclick:function onclick(e){clickFn();buttonOpts.events.onclick(e)}}),config:function config(el,inited){if(inited){return}ctrl.tabs.push({data:buttonOpts,el:el})}});return _mithril2.default.component(_button2.default,tabButtonOptions)};var sortNumbers=function sortNumbers(a,b){if(a<b)return-1;if(a>b)return 1;else return 0};var createView=function createView(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];var tag=opts.tag||"div";var autofit=opts.scrollable||opts.centered?false:opts.autofit?true:false;if(opts.selectedTab!==undefined&&opts.buttons[0].url){setSelectedTab(ctrl,opts,opts.selectedTab,true)}var props={"class":[CSS_CLASSES.block,opts.scrollable?CSS_CLASSES.scrollable:null,ctrl.selectedTabIndex===0?CSS_CLASSES.isAtStart:null,ctrl.selectedTabIndex===ctrl.tabs.length-1?CSS_CLASSES.isAtEnd:null,opts.activeSelected?CSS_CLASSES.activeSelected:null,autofit?CSS_CLASSES.isAutofit:null,opts.menu?CSS_CLASSES.isMenu:null,opts.small?CSS_CLASSES.isSmall:null,opts.class].join(" "),id:opts.id||"",config:function config(el,inited,context){if(inited){return}ctrl.tabsEl=el;if(opts.largestWidth){(function(){var widths=ctrl.tabs.map(function(tabData){return tabData.el.getBoundingClientRect().width});var largest=widths.sort(sortNumbers).reverse()[0];ctrl.tabs.forEach(function(tabData){return tabData.el.style.width=largest+"px"})})()}if(opts.scrollable){alignToTitle(ctrl)}if(opts.scrollable&&!_polythene2.default.isTouch){ctrl.managesScroll=true;createRightButtonOffset(ctrl)}var onResize=function onResize(){setSelectedTab(ctrl,opts,ctrl.selectedTabIndex,false);_mithril2.default.redraw()};_polythene2.default.addListener("resize",onResize);context.onunload=function(){_polythene2.default.removeListener("resize",onResize)};setSelectedTab(ctrl,opts,opts.selectedTab||0,false)}};var tabRow=opts.buttons.map(function(buttonOpts,index){buttonOpts=Object.assign(buttonOpts,{selected:index===ctrl.selectedTabIndex,animateOnTap:opts.animateOnTap!==undefined?opts.animateOnTap:false},opts.tabsOpts||{});return createTab(ctrl,opts,index,buttonOpts)}).concat([opts.scrollable?(0,_mithril2.default)("div",{"class":CSS_CLASSES.scrollButtonOffset}):null]);var scrollButtonLeft=undefined,scrollButtonRight=undefined;if(opts.scrollable){scrollButtonLeft=createScrollButton(ctrl,POSITION_LEFT,opts);scrollButtonRight=createScrollButton(ctrl,POSITION_RIGHT,opts)}var tabIndicator=opts.hideIndicator?null:(0,_mithril2.default)("div",{"class":CSS_CLASSES.indicator,config:function config(el,inited){if(inited){return}ctrl.tabIndicatorEl=el}});var content=[opts.scrollable?scrollButtonLeft:null,(0,_mithril2.default)("div",{"class":[CSS_CLASSES.tabRow,opts.centered?CSS_CLASSES.tabRowCentered:null,opts.scrollable?CSS_CLASSES.tabRowIndent:null].join(" "),config:function config(el,inited){if(inited){return}ctrl.scrollerEl=el},onscroll:function onscroll(){updateScrollButtons(ctrl)}},[tabRow,tabIndicator]),opts.scrollable?scrollButtonRight:null];return(0,_mithril2.default)(tag,props,[opts.before,content,opts.after])};var component={controller:function controller(){return{tabsEl:null,scrollerEl:null,tabs:[],tabIndicatorEl:null,selectedTabIndex:0,managesScroll:false,scrollButtonStates:{left:false,right:false}}},view:function view(ctrl){var opts=arguments.length<=1||arguments[1]===undefined?{}:arguments[1];return createView(ctrl,opts)}};exports.default=component;module.exports=exports["default"];